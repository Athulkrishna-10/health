<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Medical Triage Assistant</title>

    <style>
        body {
            background: linear-gradient(135deg, #d7e9ff, #f0f7ff);
            font-family: "Segoe UI", Arial, sans-serif;
            display: flex;
            justify-content: center;
            padding-top: 40px;
        }

        #chat-container {
            width: 480px;
            background: white;
            border-radius: 22px;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            border: 1px solid #bcd7ff;
        }

        #header {
            background: linear-gradient(90deg, #0A84FF, #4ca9ff);
            padding: 18px;
            text-align: center;
            color: white;
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        #messages {
            padding: 18px;
            height: 520px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: #f2f7ff;
        }

        .bubble {
            max-width: 80%;
            padding: 14px 18px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 16px;
            background: #eef5ff;
            white-space: pre-line;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .user {
            background: #d6e6ff;
            align-self: flex-end;
        }

        .bot {
            background: #eef5ff;
            align-self: flex-start;
            border: 1px solid #d1e1ff;
        }

        .audio-btn {
            margin-top: 10px;
            padding: 8px 14px;
            background: #0A84FF;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 13px;
        }

        #input-area {
            display: flex;
            padding: 14px;
            gap: 10px;
            border-top: 1px solid #c8ddff;
        }

        #promptInput {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #b4ceff;
            font-size: 16px;
        }

        #sendBtn, #recordBtn {
            padding: 10px 18px;
            background: #0A84FF;
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
        }

        #recordBtn.recording {
            background: red !important;
        }
    </style>
</head>

<body>

<div id="chat-container">
    <div id="header">Medical Triage Assistant</div>

    <div id="messages"></div>

    <div id="input-area">
        <button id="recordBtn">üé§</button>
        <input id="promptInput" placeholder="Describe your symptoms...">
        <button id="sendBtn">Send</button>
    </div>
</div>

<script>
let mediaRecorder;
let audioChunks = [];
let isRecording = false;

const messagesBox = document.getElementById("messages");

/* Clean LLM output */
function formatBotText(text) {
    return text
        .replace("(type: follow_up)", "")
        .replace("(type: final_recommendation)", "")
        .replace(/\\n/g, " ")
        .replace(/\n/g, " ")
        .replace(/Q:\s*/g, "")
        .replace(/["]/g, "")
        .trim();
}

/* Add message bubble */
function addMessage(text, type, withAudio = false) {
    const bubble = document.createElement("div");
    bubble.classList.add("bubble", type);
    bubble.innerText = text;

    if (type === "bot" && withAudio) {
        const audioBtn = document.createElement("button");
        audioBtn.classList.add("audio-btn");
        audioBtn.innerText = "üîä Hear Voice";

        audioBtn.onclick = async () => {
            const formData = new FormData();
            formData.append("text", text);

            const res = await fetch("/text_speech", {
                method: "POST",
                body: formData
            });

            const blob = await res.blob();
            new Audio(URL.createObjectURL(blob)).play();
        };

        bubble.appendChild(document.createElement("br"));
        bubble.appendChild(audioBtn);
    }

    messagesBox.appendChild(bubble);
    messagesBox.scrollTop = messagesBox.scrollHeight;
}

/* RECORD VOICE */
document.getElementById("recordBtn").onclick = async () => {
    const btn = document.getElementById("recordBtn");

    if (!isRecording) {
        audioChunks = [];

        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = sendAudioToBackend;

        mediaRecorder.start();
        isRecording = true;
        btn.classList.add("recording");
        btn.innerText = "‚èπ Stop";

    } else {
        mediaRecorder.stop();
        isRecording = false;
        btn.classList.remove("recording");
        btn.innerText = "üé§";
        addMessage("üéô Processing your voice...", "bot");
    }
};

/* Convert WEBM ‚Üí WAV */
function audioBufferToWav(buffer) {
    const numChannels = buffer.numberOfChannels;
    const sampleRate = buffer.sampleRate;
    const samples = buffer.length;

    const blockAlign = numChannels * 2;
    const byteRate = sampleRate * blockAlign;

    const dataSize = samples * blockAlign;
    const bufferSize = 44 + dataSize;

    const arrayBuffer = new ArrayBuffer(bufferSize);
    const view = new DataView(arrayBuffer);

    function writeString(offset, string) {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    }

    let offset = 0;

    writeString(offset, 'RIFF'); offset += 4;
    view.setUint32(offset, bufferSize - 8, true); offset += 4;
    writeString(offset, 'WAVE'); offset += 4;

    writeString(offset, 'fmt '); offset += 4;
    view.setUint32(offset, 16, true); offset += 4;
    view.setUint16(offset, 1, true); offset += 2;
    view.setUint16(offset, numChannels, true); offset += 2;
    view.setUint32(offset, sampleRate, true); offset += 4;
    view.setUint32(offset, byteRate, true); offset += 4;
    view.setUint16(offset, blockAlign, true); offset += 2;
    view.setUint16(offset, 16, true); offset += 2;

    writeString(offset, 'data'); offset += 4;
    view.setUint32(offset, dataSize, true); offset += 4;

    let pos = offset;
    for (let i = 0; i < samples; i++) {
        for (let ch = 0; ch < numChannels; ch++) {
            const sample = buffer.getChannelData(ch)[i];
            const val = Math.max(-1, Math.min(1, sample));
            view.setInt16(pos, val * 0x7FFF, true);
            pos += 2;
        }
    }

    return arrayBuffer;
}

/* Send audio to backend */
async function sendAudioToBackend() {
    const audioBlob = new Blob(audioChunks, { type: "audio/webm" });

    const arrayBuffer = await audioBlob.arrayBuffer();
    const audioCtx = new AudioContext();
    const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

    const wavBuffer = audioBufferToWav(audioBuffer);
    const wavBlob = new Blob([wavBuffer], { type: "audio/wav" });

    const formData = new FormData();
    formData.append("voice", wavBlob, "audio.wav");

    const res = await fetch("/speech", {
        method: "POST",
        body: formData
    });

    const data = await res.json();

    addMessage("üó£ " + data[1], "user");

    let clean = formatBotText(data[0]);
    addMessage(clean, "bot", true);
}

/* Send text */
document.getElementById("sendBtn").onclick = async () => {
    const text = document.getElementById("promptInput").value.trim();
    if (!text) return;

    addMessage(text, "user");

    const formData = new FormData();
    formData.append("prompt", text);

    const res = await fetch("/llm", { method: "POST", body: formData });
    let reply = await res.text();

    let clean = formatBotText(reply);
    addMessage(clean, "bot", true);

    document.getElementById("promptInput").value = "";
};
</script>

</body>
</html>
